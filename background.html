<!doctype html>
<html>

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width" />
  <title>LSP Reloader</title>

  <script src="https://unpkg.com/@replit/extensions@1.9.0/dist/index.global.js"></script>
  <script>
    module = {
      exports: {}
    };
  </script>
  <script src="https://unpkg.com/ion-parser@0.5.2/parser.js"></script>
  <script>
    delete module;
  </script>
  <script>
    /**
     * @param {string} lspCmd
     * @returns {string} The LSP's PID
     */
    async function psLsp(lspCmd) {
      const ps = (await replit.exec.exec('ps -ef | grep ' + JSON.stringify(
        lspCmd.replace(/([a-z])/i, '[$1]')
      ))).output;

      return ps.match(/^(\w+)\s+(\d+)/i)[2];
    }

    document.addEventListener('DOMContentLoaded', async () => {
      await replit.init();

      const dotReplitRaw = (await replit.fs.readFile('.replit')).content;
      const dotReplit = ION.parse(dotReplitRaw);

      console.debug('[LSP Reloader] dotReplit:', dotReplit);

      const lsps = [];
      for (const [langId, lang] of Object.entries(dotReplit.languages)) {
        if (!lang?.languageServer?.start) {
          continue;
        }

        lsps.push({
          id: langId,
          cmd: lang.languageServer.start
        });
      }

      if (lsps.length) {
        console.groupCollapsed('[LSP Reloader] Found', lsps.length, 'configured LSPs');
        for (const lsp of lsps) {
          console.debug(lsp);
        }
        console.groupEnd();
      } else {
        console.debug('[LSP Reloader] Found no configured LSPs');
      }

      await replit.extensionPort.internal.commands.registerCommand(replit.proxy({
        data: {
          id: 'lsp-reloader',
          type: 'context',
          label: 'LSP Reloader',
          description: 'A Replit extension that can reload LSPs when they die, so that you don\'t have to reboot the Repl all the time.',
          icon: 'icons/icon.png',
          contributions: ["commandbar"]
        },
        commands: async ({ active }) => {
          if (!active) {
            return replit.proxy([]);
          }

          return replit.proxy(lsps.map((lsp) => replit.proxy({
            data: {
              id: `lsp-reloader-${lsp.id}`,
              type: 'action',
              label: lsp.id,
              description: lsp.id,
              icon: 'icons/icon.png'
            },
            run: async () => {
              // Get the LSP's PID
              const pid = await psLsp(lsp.cmd);

              // Kill it
              console.debug('[LSP Reloader] Killing', lsp.id, 'LSP with PID', pid);
              await replit.exec.exec(`kill ${pid}`);
            }
          })));
        }
      }));
    });
  </script>
</head>

<body>

</body>

</html>